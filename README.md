Библиотека `SmartThingLib` нацелена на значительное ускорение разработки IOT устройств реализуя в себе большую часть базового функционала. Поддерживаемые платформы - `esp32` и `esp8266`. Для создания устройства вам достаточно указать его тип, какие действия оно умеет делать, какой набор датчиков имеет и возможные настройки устройства. Готовое устройство имеет веб интерфейс для управления и настройки.
Так же реализовано приложение маршрутизатора и облака для управления множеством устройств. Их можно найти [на главной странице проекта SmartThing](https://github.com/poboopo/SmartThingProject).

%% todo pictures %%
## Как использовать
Для работы требуются следующие библиотеки:
```
bblanchon/ArduinoJson@^7.0.4
esphome/ESPAsyncWebServer-esphome@^3.2.2
```

На этапе инциализации устройства необходимости произвести все настройки. Добавление действия устройства:

```C++
/*
	При добавлении действия необходимо указать:
	- его системное название
	- текст для отображения в UI
	- лямбду с логикой действия, которая возвращает true или false
*/
ActionsManager.add("led_on", "Turn led on", []() {
	digitalWrite(LED_PIN, LOW);
	return true;
});
```

Поддерживается несколько видов сенсоров. Пример добавления стандартных сенсоров для чтения показаний с digital и analog пинов:

```C++
// Метод добавляет сенсор с указанным названием, настраивает пин и читает его значение с помощью digitalRead
SensorsManager.addDigital"button", 12);
// А этот читает значение с пина с помощью analogRead
SensorsManager.addAnalog("analog", 14);
```

Если показатели сенсоров считываются каким либо другим образом, можно их добавить с указанием лямбды, которая расчитывает их значение. Поддерживаются числовые (`int`) и текстовые (`String`) значения сенсоров:

```c++
// Числовой сенсор по умолчанию хранит в себе long
// Добавление числового сенсора с кастомной логикой вычисления значения
SensorsManager.add("sensor", []() {
	return tempSensor.readData();
});
// Текстовый сенсор по умолчанию хранит в себе String
// Добавление текстового сенсора
SensorsManager.add("led", []() {
	// Пример возможной логики вычисления значения
	return digitalRead(LED_PIN) == HIGH ? "on" : "off";
});
```

Устройству можно добавить настройки, которые может изменять пользователь и с которыми может взаимодействовать разработчик:

```C++
// Для добавления конфигурации необходимо указать уникальное название ключа
ConfigManager.add("test-value");

// Получить его значение в коде, по ключу
ConfigManager.get("test-value");

// Можно добавить слушатель на обновление конфигурации устройства
ConfigManager.onConfigUpdate([]() {
	st_log_debug("main", "Config updated!");
});
```
Значения конфигурации хранятся в виде строк в `EEPROM` памяти устройства и доступны после перезагрузки.

После настройки возможностей устройства необходимо проинициализировать `SmartThing`:

```C++
// Необходимо указать тип устройства
if (!SmartThing.init("lamp")) {
	// Не удалось инциализировать устройство
	st_log_error("main", "Failed to init SmartThing!");
	while(true) {
		delay(1000);
	}
}
```

Если используется `esp8266`, то необходимо в главном методе loop добавить вызвов метода `SmartThing.loop()`:

```C++
void loop() {
	SmartThing.loop();
	delay(250);
}
```

В случае `esp32` этого делать не надо, loop метод будет вызываться в отдельной асинхронной таске.

Полный пример прошивки можно посмотреть  [в тестовом репозитории](https://github.com/poboopo/SmartThingLibTest/blob/master/src/main.cpp). 

Для ещё большего упрощения начала разработки устройства был сделан простой конструктор прошивки [`SmartThingBuilder`](https://pobopo.ru/st/builder/). Он позволит создать каркас будущего устройства, где разработчику надо будет только точечно добавить свою логику в нужных местах.

%% BUILDER PICTURE %%

## Дополнительные фичи
В библиотеке есть своя реализация сетевого логгера - макросы `st_log_error`, `st_log_warning`, `st_log_info` и `st_log_debug`.  По умолчанию используется стандартный сериал, но в настройках устройства можно будет указать `tcp` сервер для получения логов - настройка `laddr`. К нему будет подключаться устройство. Адрес сервера указаывается в формате `ip:port`. В приложении маршрутизатора есть встроенный сервер для сбора логов.

Возможно отключение не используемого функционала с помощью фича флагов на этапе сборки. Это позволит уменьшить размер финальной прошивки. Подробнее про них можно почитать в [FEATURE_FLAGS.md](https://github.com/poboopo/SmartThingLib/blob/master/FEATURE_FLAGS.md). 

## Примеры
- [Тестовый проект](https://github.com/poboopo/SmartThingLibTest/blob/master/src/main.cpp)
- [Метео станция](https://github.com/PavelProjects/meteo_station)
- [Автоматические жалюзи](https://github.com/PavelProjects/SmarThingtLouver)